<!DOCTYPE html>
<html class="h-full">
  <head>
    <title><%= content_for(:title) || "Î™®Í∏∞Ïû°Ïù¥ Ïª§ÎÆ§ÎãàÌã∞" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Î™®Í∏∞Ïû°Ïù¥ Ïª§ÎÆ§ÎãàÌã∞">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <%# Cloudinary Upload Widget %>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  </head>

  <body class="h-full bg-gray-900 text-white">
    <!-- Navigation -->
    <nav id="main-nav" class="fixed top-0 left-0 right-0 glass z-50 transition-all duration-300">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex items-center justify-between h-16">
          <!-- Logo -->
          <%= link_to root_path, class: "flex items-center gap-2 text-xl font-bold text-white hover:text-green-400 transition-all duration-300 group" do %>
            <span class="text-2xl group-hover:animate-fly">ü¶ü</span>
            <span class="hidden sm:inline text-gradient font-extrabold">Î™®Í∏∞Ïû°Ïù¥</span>
          <% end %>

          <!-- Main Nav (Desktop) -->
          <div class="hidden md:flex items-center gap-1">
            <%= link_to posts_path, class: "px-4 py-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-lg transition-all duration-200 font-medium" do %>
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Í∞§Îü¨Î¶¨
              </span>
            <% end %>
            <%= link_to rankings_path, class: "px-4 py-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-lg transition-all duration-200 font-medium" do %>
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Îû≠ÌÇπ
              </span>
            <% end %>
            <%= link_to donations_path, class: "px-4 py-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-lg transition-all duration-200 font-medium" do %>
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
                Í∏∞Î∂Ä
              </span>
            <% end %>
            <%= link_to nfts_path, class: "px-4 py-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-lg transition-all duration-200 font-medium" do %>
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                NFT
              </span>
            <% end %>
            <% if user_signed_in? %>
              <%= link_to avatar_path, class: "px-4 py-2 text-gray-300 hover:text-white hover:bg-white/10 rounded-lg transition-all duration-200 font-medium" do %>
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  ÏïÑÎ∞îÌÉÄ
                </span>
              <% end %>
            <% end %>
          </div>

          <!-- User Section -->
          <div class="flex items-center gap-3">
            <% if user_signed_in? %>
              <!-- Upload Button -->
              <%= link_to new_post_path, class: "px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-400 hover:to-emerald-400 rounded-xl text-white font-semibold transition-all duration-300 flex items-center gap-2 neon-green" do %>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <span class="hidden sm:inline">ÏóÖÎ°úÎìú</span>
              <% end %>

              <!-- User Avatar -->
              <div class="flex items-center gap-2 px-3 py-1.5 rounded-xl hover:bg-white/10 transition-all duration-200 cursor-pointer">
                <% if current_user.avatar_url.present? %>
                  <img src="<%= current_user.avatar_url %>" alt="" class="w-8 h-8 rounded-full ring-2 ring-green-500/50">
                <% else %>
                  <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center ring-2 ring-green-500/50">
                    <span class="text-sm font-bold"><%= current_user.display_name&.first&.upcase || '?' %></span>
                  </div>
                <% end %>
                <span class="hidden lg:inline text-sm text-gray-300 font-medium"><%= current_user.display_name || current_user.username %></span>
              </div>

              <!-- Logout Button -->
              <button id="clerk-sign-out-btn" class="p-2 text-gray-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-all duration-200" title="Î°úÍ∑∏ÏïÑÏõÉ">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
              </button>
            <% else %>
              <button id="clerk-sign-in-btn" class="px-5 py-2.5 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-400 hover:to-emerald-400 rounded-xl text-white font-semibold transition-all duration-300 neon-green">
                Î°úÍ∑∏Ïù∏
              </button>
            <% end %>

            <!-- Mobile Menu Button -->
            <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition-all duration-200">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile Menu -->
      <div id="mobile-menu" class="md:hidden hidden glass-card border-t border-white/10">
        <div class="px-4 py-3 space-y-1">
          <%= link_to posts_path, class: "flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Í∞§Îü¨Î¶¨
          <% end %>
          <%= link_to rankings_path, class: "flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            Îû≠ÌÇπ
          <% end %>
          <%= link_to donations_path, class: "flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            Í∏∞Î∂Ä
          <% end %>
          <%= link_to nfts_path, class: "flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            NFT
          <% end %>
          <% if user_signed_in? %>
            <%= link_to avatar_path, class: "flex items-center gap-3 px-4 py-3 text-gray-300 hover:text-white hover:bg-white/10 rounded-xl transition-all duration-200" do %>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
              </svg>
              ÏïÑÎ∞îÌÉÄ
            <% end %>
          <% end %>
        </div>
      </div>
    </nav>

    <!-- Flash Messages -->
    <% if notice %>
      <div class="fixed top-20 left-1/2 -translate-x-1/2 z-50 glass px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3" data-controller="flash">
        <div class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0">
          <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <span class="text-white font-medium"><%= notice %></span>
      </div>
    <% end %>
    <% if alert %>
      <div class="fixed top-20 left-1/2 -translate-x-1/2 z-50 glass px-6 py-4 rounded-2xl shadow-2xl border border-red-500/30 flex items-center gap-3" data-controller="flash">
        <div class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center flex-shrink-0">
          <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <span class="text-white font-medium"><%= alert %></span>
      </div>
    <% end %>

    <!-- Main Content -->
    <main class="pt-16 min-h-screen">
      <%= yield %>
    </main>

    <!-- Footer -->
    <footer class="glass border-t border-white/10 py-12 mt-16">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center gap-6">
          <!-- Logo & Mission -->
          <div class="text-center md:text-left">
            <div class="flex items-center justify-center md:justify-start gap-2 mb-3">
              <span class="text-3xl">ü¶ü</span>
              <span class="text-xl font-bold text-gradient">Î™®Í∏∞Ïû°Ïù¥</span>
            </div>
            <p class="text-gray-400 max-w-md">
              ÏàòÏùµÏùò <span class="text-green-400 font-semibold">50%</span>Îäî ÎßêÎùºÎ¶¨ÏïÑ Ìá¥Ïπò Îã®Ï≤¥Ïóê Í∏∞Î∂ÄÎê©ÎãàÎã§
            </p>
          </div>

          <!-- Links -->
          <div class="flex items-center gap-6">
            <%= link_to posts_path, class: "text-gray-400 hover:text-white transition-colors" do %>
              Í∞§Îü¨Î¶¨
            <% end %>
            <%= link_to rankings_path, class: "text-gray-400 hover:text-white transition-colors" do %>
              Îû≠ÌÇπ
            <% end %>
            <%= link_to donations_path, class: "text-gray-400 hover:text-white transition-colors" do %>
              Í∏∞Î∂Ä
            <% end %>
            <%= link_to nfts_path, class: "text-gray-400 hover:text-white transition-colors" do %>
              NFT
            <% end %>
          </div>
        </div>

        <!-- Copyright -->
        <div class="mt-8 pt-8 border-t border-white/10 text-center">
          <p class="text-sm text-gray-500">
            &copy; <%= Time.current.year %> Î™®Í∏∞Ïû°Ïù¥ Ïª§ÎÆ§ÎãàÌã∞. Made with <span class="text-red-400">hate</span> for mosquitoes.
          </p>
        </div>
      </div>
    </footer>

    <!-- Clerk Frontend -->
    <script async crossorigin="anonymous" data-clerk-publishable-key="<%= ENV['CLERK_PUBLISHABLE_KEY'] %>" src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
    <script>
      let clerkReady = false;

      // Initialize Clerk first
      const initClerk = async () => {
        if (typeof Clerk === 'undefined') {
          setTimeout(initClerk, 100);
          return;
        }

        try {
          await Clerk.load();
          clerkReady = true;
          console.log("Clerk ready!");

          // Update button to show it's ready
          const signInBtn = document.getElementById("clerk-sign-in-btn");
          if (signInBtn) {
            signInBtn.style.opacity = "1";
          }

          // Sync user session with Rails backend
          if (Clerk.user) {
            const sessionToken = await Clerk.session.getToken();
            document.cookie = `__session=${sessionToken}; path=/; samesite=lax`;

            // If Rails didn't recognize us (login button is still visible), reload
            const signInBtnVisible = document.getElementById("clerk-sign-in-btn");
            if (signInBtnVisible) {
              console.log("Clerk user exists but Rails shows login button - syncing and reloading...");
              // First sync user to backend
              try {
                await fetch("/webhooks/clerk", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
                  },
                  body: JSON.stringify({
                    type: "user.created",
                    data: Clerk.user
                  })
                });
              } catch (err) {
                console.log("User sync error:", err);
              }
              // Then reload to let Rails see the cookie
              window.location.reload();
              return;
            }
          }

          // Listen for sign-out events (user was signed in, now signing out)
          Clerk.addListener(({ user }) => {
            const isSignedIn = !!user;
            // If user signs out, reload to show login button
            if (!isSignedIn && !document.getElementById("clerk-sign-in-btn")) {
              console.log("User signed out, reloading...");
              document.cookie = "__session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
              window.location.reload();
            }
          });
        } catch (err) {
          console.error("Clerk init error:", err);
        }
      };

      // Attach click handler
      document.addEventListener("DOMContentLoaded", () => {
        const signInBtn = document.getElementById("clerk-sign-in-btn");
        if (signInBtn) {
          // Start slightly faded until Clerk is ready
          signInBtn.style.opacity = "0.7";

          signInBtn.addEventListener("click", async (e) => {
            e.preventDefault();

            if (!clerkReady) {
              signInBtn.textContent = "Î°úÎî© Ï§ë...";
              // Wait for Clerk to be ready
              while (!clerkReady) {
                await new Promise(r => setTimeout(r, 100));
              }
              signInBtn.textContent = "Î°úÍ∑∏Ïù∏";
            }

            Clerk.openSignIn({
              forceRedirectUrl: window.location.href
            });

            // Fallback: Check for sign-in after modal interaction
            const checkSignIn = setInterval(() => {
              if (Clerk.user) {
                clearInterval(checkSignIn);
                console.log("User signed in, reloading...");
                window.location.reload();
              }
            }, 500);

            // Stop checking after 2 minutes
            setTimeout(() => clearInterval(checkSignIn), 120000);
          });
        }

        // Logout button handler
        const signOutBtn = document.getElementById("clerk-sign-out-btn");
        if (signOutBtn) {
          signOutBtn.addEventListener("click", async (e) => {
            e.preventDefault();

            if (!clerkReady) {
              alert("Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...");
              return;
            }

            await Clerk.signOut();
            // Clear session cookie
            document.cookie = "__session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT";
            window.location.href = "/";
          });
        }

        // Start Clerk initialization
        initClerk();

        // Mobile Menu Toggle
        const mobileMenuBtn = document.getElementById("mobile-menu-btn");
        const mobileMenu = document.getElementById("mobile-menu");
        if (mobileMenuBtn && mobileMenu) {
          mobileMenuBtn.addEventListener("click", () => {
            mobileMenu.classList.toggle("hidden");
            // Toggle hamburger to X icon
            const icon = mobileMenuBtn.querySelector("svg");
            if (mobileMenu.classList.contains("hidden")) {
              icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>';
            } else {
              icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>';
            }
          });
        }

        // Scroll Effect for Navigation
        const nav = document.getElementById("main-nav");
        let lastScroll = 0;
        window.addEventListener("scroll", () => {
          const currentScroll = window.pageYOffset;
          if (currentScroll > 50) {
            nav.classList.add("shadow-lg", "shadow-black/20");
          } else {
            nav.classList.remove("shadow-lg", "shadow-black/20");
          }
          lastScroll = currentScroll;
        });
      });
    </script>
  </body>
</html>
